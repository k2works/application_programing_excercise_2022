:toc: left
:toclevels: 5
:sectnums:
:stem:
:source-highlighter: coderay

= Todoアプリケーション

== 要求
== 構築
[cols="1,1,1"]
|===
|ソフトウェア |バージョン |備考

|Node.js

|16.3.0

|
|===

=== アプリケーションコンポーネント
[plantuml]
----
package "SPA" {
  [React]
  [ReduxToolkit]
}
HTTP - SPA

package "API" {
  [Express]
  [TypeORM]
}
API -- HTTP

database "Sqlite" {
  frame "Schema" {
    [todo]
  }
}

TypeORM - Sqlite
----

=== コンポーネントセットアップ
==== 開発共通

[source, bash]
----
npm init -y
npm install --save-dev @babel/core @babel/cli @babel/preset-env @babel/register
npm install --save-dev npm-run-all watch foreman cpx rimraf marked
npm install --save-dev webpack webpack-cli html-webpack-plugin webpack-dev-server 
touch Procfile
----

==== テスト
[source, bash]
----
npm install --save-dev jest
npm install cypress
npmx cypress open
npm install --save-dev cypress-cucumber-preprocessor
npm install --save-dev cucumber-html-reporter
----

==== クライアント関連
[source, bash]
----
npm install --save-dev style-loader css-loader
npm install --save-dev fake-indexeddb
npm install dexie
----

==== React

[source, bash]
----
npm install react react-dom
npm install --save-dev babel-loader @babel/preset-react
----

==== TypeScript

[source, bash]
----
npm install --save-dev typescript ts-loader
npx tsc --init
npm install -save-dev @types/react @types/react-dom
npm install --save-dev typescript@4.5.5 jest@27.5.1 ts-jest@27.1.3 ts-node-dev@1.1.8 @types/jest
----

==== ReduxToolkit

[source, bash]
----
npm install -save @reduxjs/toolkit react-redux
npm install -save axios @types/axios
npm install --save express uuid cors

----

==== API関連
[source, bash]
----
npm install --save ts-node@10.5.0 @types/express @types/cors @types/node
npm install --save-dev ts-node-dev@1.1.8 
npm install --save cross-env
npm install --save typeorm reflect-metadata 
npm install --save better-sqlite3 
----

==== ドキュメント
[source, bash]
----
npm install --save-dev typedoc tplant
npm install --save-dev asciidoctor asciidoctor-kroki
npm install -save tsoa swagger-ui-express
npm install -save @types/swagger-ui-express
----

== 配置
=== システムアーキテクチャ

[plantuml]
----
@startuml
actor 開発者
actor 利用者
cloud "Heroku" as Heroku {
    package "Production Environment" as prd {
      [API] as app_api_prd
      [SPA] as app_spa_prd
    }
}

cloud "Vercel" as Vercel {
    package "Development Environment" as dev {
      [SPA] as app_spa_dev
    }
}

cloud "GitHub" as github {
  [Git] as repository
}

開発者 --> app_spa_dev
開発者 --> app_spa_prd
開発者 --> repository
app_spa_prd <-- 利用者
repository --> prd
repository --> dev
@enduml
----

== 開発
=== 仕様

[source, yml]
----
include::../cypress/integration/App.feature[]
----

=== 設計

==== ユースケース
[plantuml]
----
left to right direction
skinparam packageStyle rectangle
actor 利用者
rectangle TodoApp {
  利用者 -- (やることを追加する)
  利用者 -- (やることを編集する)
  利用者 -- (やることを削除する)
}
----

==== ドメインモデル

image::images/domain_model.drawio.svg[]

==== アプリケーションアーキテクチャ
[plantuml]
----
package SPA {
}
package API {
  package domain {
    package model {}
    package type {}
    type <- model
  }
  package presentation {
  }
  package application {
  }
  package infrastracture {
    package entity {}
    package repository {}
  }
  presentation -> application
  application -> model
  application -> repository
  model <-- repository
  repository -> entity
}
presentation <-- SPA
----

==== オブジェクトモデル

===== API

[plantuml]
----
package domain {
  package model {
    package todo {
      class TodoList {}
      class Todo {
        id
        isCompleted
        isOverDue
        completed()
        setDueDate(dueDate)
      }
      class Title {}
      class CreatedAt {}
      class CompletedAt {}
      class DueDate {
        overDue()
      }
    }
    package status {
      abstract class TodoStatus {
        static create()
      }
      interface Status {}
      class NotStarted extends TodoStatus {}
      class InProgress extends TodoStatus {}
      class Completed extends TodoStatus {}
    }
    Todo *-- Title
    Todo *-- CreatedAt
    Todo *-- CompletedAt
    Todo *-- DueDate
    TodoList *-- Todo
    TodoStatus -|> Status
    Status -* Todo
  }
  package type {
    enum TodoStatusType {
      UNDEFINED = 0,
      NOT_STARTED = 1,
      IN_PROGRESS = 2,
      COMPLETED = 3,
    }
  }
  TodoStatusType -* TodoStatus
}
package presentation {
  class TodoController {
    selectAll()
    create()
    delete()
    update()
  }
}
package application {
  interface Service {}
  class TodoService {
    create(params)
    selectAll()
    update(params)
    delete(params)
  }
  Service <|- TodoService
}
package infrastructure {
  package entity {
    class TodoEntity {
      id
      title
      completed
      dueDate
      createdAt
      completedAt
      status
    }
  }
  package repository {
    interface Repository {}
    class TodoRepository {
      getTodos()
      getTodo()
      addTodo(todo)
      deleteTodo(todo)
      updateTodo(todo)
    }
    Repository <|- TodoRepository
  }
  class router {
    get()
    post()
    put()
    delete()
  }
  class Express {}
}
Express <- router
TodoController <-- router
TodoController *-- Service
TodoService *-- Repository
Todo <-- TodoService
TodoList <-- TodoService
Todo <--- TodoRepository
TodoList <--- TodoRepository
TodoRepository -> TodoEntity
----

===== SPA

[plantuml]
----
package app {
  class React {}
  class App {}
  class Todo {
    dispatch
  }
}
package components {
  class TodoList{
    todos
  }
  class TodoItem{
    dispatch
    todo
    completed
    dueDate
    setCompleted()
    setDueDate()
  }
  class TodoInput{
    dispatch
    todo
    isError
  }
  class TodoItemCount{
    count
  }
  class TodoMessage{
    message
  }
  TodoList *-- TodoItem
}
package features {
  class todoSlice {
    initialState
    selectTodo()
    selectTodos()
    selectTodoCount()
    selectTodoMessage()
    selectIsError()
    readTodoAsync()
    createTodoAsync()
    updateTodoAsync()
    deleteTodoAsync()
  }
}
package reducers {
  class index {
    rootReducer
  }
}
App -> React
Todo <- App
Todo *-- TodoList
Todo *-- TodoInput 
Todo *-- TodoMessage 
Todo *-- TodoItemCount 
todoSlice <-- Todo
index *-- todoSlice
todoSlice -> Redux
Redux <- index
----

==== データモデル
[plantuml]
----
entity Todo {
  * id : number <<generated>>
  --
  title : varchar
  completed : boolean
  dueDate : datetime
  createdAt : datetime
  completedAt : datetime
}
entity Status {
  *id : number <<generated>>
  --
  type : varchar
  code : varchar
  name : varchar
}
Status ||.o{ Todo
----

== 運用

=== 開発

[source, bash]
----
npm start
----

=== テスト 

[source, bash]
----
npm run test
----

=== ビルド

[source, bash]
----
npm build
----

=== デプロイ

[source, bash]
----
npm run deploy
----

=== ドキュメント
[source, bash]
----
npm run build:docs
----

== 参照

- https://vercel.com/[Vercel]
- https://webpack.js.org/[webpack]
- https://qiita.com/SnowCait/items/487d70b342ffbe2f33d8[GitHub Actions でステータスバッジを表示する]
- https://www.cypress.io/[cypress]
- https://www.npmjs.com/package/cypress-cucumber-preprocessor[cypress-cucumber-preprocessor]
- https://github.com/andyhaskell/indexeddb-tutorial[IndexedDB tutorial example code]
- https://dexie.org/[Dexie.js]
- https://ics.media/entry/16028/[最新版で学ぶwebpack 5入門 Babel 7でES2021環境の構築]
- https://qiita.com/gakinchoy7/items/30d37bf912b21359ac3c#usecontext%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E5%AE%9F%E8%A3%85[おんなじTODOアプリをuseState / useReducer / useContext / Redux / Recoil を使って実装してみた]
- https://ics.media/entry/16329/[最新版TypeScript+webpack 5の環境構築まとめ]
- https://typeorm.io/[TypeORM]
- http://typedoc.org/[TYPE DOC]
- https://github.com/bafolts/tplant[tplant]
 https://typescript-jp.gitbook.io/deep-dive/[TypeScript Deep Dive 日本語版]
- https://dev.to/rsbh/building-rest-api-with-express-typescript-and-swagger-2dma[Building REST API with Express, TypeScript and Swagger]
- https://tsoa-community.github.io/docs/[tsoa]