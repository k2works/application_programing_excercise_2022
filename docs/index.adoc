:toc: left
:toclevels: 5
:sectnums:
:stem:
:source-highlighter: coderay

= 花束問題のケーススタディ

== 背景

=== ドメイン

[quote,花束問題V1.2 事業と問題の概要]
____
フラワーショップ「フレール・メモワール」は店舗売りとは切り離してWEBショップ事業を立ち上げた。WEBで注文を受け付けて、指定された日付に指定場所に花束を届けるという形態。

当初は受注も少なく手作業で管理出来ていたが、受注が増えるにつれシステム化の必要性が出てきた。「新鮮な花を大切な記念日に」を売り文句にしていることもあって、廃棄される在庫が多く、受注の増加にともなって利益が伸びていないため。
____

=== 組織図

=== SWOT分析

=== ビジネスモデル

== 要件

要件定義にはリレーションシップ駆動要件分析(RDRA)を使用する。

RDRAとは短時間で要件を把握することを目的とした軽量の手法。 RDRAでは、決められたアイコンを使い、アイコンとアイコン、アイコンと図を関連づけ、アイコンで表現されたモデル要素と関連のつながりから要件を説明する。

____
image::images/rdra.png[]
image::images/rdra2.png[]
____

https://www.amazon.co.jp/RDRA2-0-%E3%83%8F%E3%83%B3%E3%83%89%E3%83%96%E3%83%83%E3%82%AF-%E8%BB%BD%E3%81%8F%E6%9F%94%E8%BB%9F%E3%81%A7%E7%B2%BE%E5%BA%A6%E3%81%AE%E9%AB%98%E3%81%84%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%81%AE%E3%83%A2%E3%83%87%E3%83%AA%E3%83%B3%E3%82%B0%E6%89%8B%E6%B3%95-%E7%A5%9E%E5%B4%8E%E5%96%84%E5%8F%B8-ebook/dp/B07STQZFBX[RDRA2.0 ハンドブックより引用]

また、要件定義は開発と並行して都度反映され運用にも影響を与える。

image::images/life_cycle.drawio.svg[]

=== システム価値

==== システムコンテキスト

[plantuml]
----
@startuml

title システムコンテキスト図

left to right direction

actor ユーザー as ac_01
actor スタッフ as ac_02
actor 顧客 as ac_03
ac_01 <|-- ac_02
ac_01 <|-- ac_03

note top of ac_01
  ユーザーとはシステムを利用するアクター全般を指す。
  お金を払って製品を購入する顧客。
  販売管理業務を担当するスタッフ。
end note

usecase 販売管理システム as uc_01
note top of uc_01
  顧客の受注を管理できるようにする。
  商品の受発注を管理できるようにする。
  商品の在庫を管理できるようにする。
end note

usecase 販売サイト as uc_02
note top of uc_02
  顧客がオンラインで商品を注文できるようにする。
end note

ac_02 -- (uc_01)
ac_03 -- (uc_02)

@enduml
----

==== 要求モデル

===== 顧客

[plantuml]
----
@startuml

title 要求モデル図

left to right direction

actor 顧客 as ac_01
note "オンラインで商品を閲覧したい" as k_r1
note "オンラインで商品を購入したい" as k_r2
note as k_dr1 #Turquoise
 ＩＤの登録の際にクレジットカード情報を入れるため請求や入金に関しては考慮する必要はない
end note

ac_01 -- k_r1
ac_01 -- k_r2
k_r2 -- k_dr1

@enduml
----

===== スタッフ

[plantuml]
----
@startuml

title 要求モデル図

left to right direction

actor スタッフ as ac_02
note "商品と在庫を管理したい" as k_r3
note "得意先と受注・出荷を管理したい" as k_r4
note "発注と入荷を管理したい" as k_r5
note as k_dr2 #Turquoise
 花束の組み合わせは事前に「商品」として決めうちされている。
 １個の商品あたり、どの「単品（後述）」がどれだけ必要かも決められている。
 シングルレベルしかない部品表のようなもの。
 単品の在庫も含めて、保管場所は１箇所で、これが増える予定もない。
end note
note as k_dr3 #Turquoise
 花束の材料となるそれぞれの花は「単品」として管理される。
 「単品」はそれぞれ特定の仕入先から購入され、単品毎に品質維持可能日数が決められている。
 購入後にその日数を超えると結束には利用できずに廃棄されなければならない。
 なお、受注・出荷されるものは「商品」のみであって、単品がそのまま出荷されることはない。
end note
note as k_dr4 #Turquoise
 リピータを期待するので、得意先（個人のみ）情報を管理したい。
 届け先は毎回違う可能性があるが、前回の受注情報から届け先を簡単にコピーできるような機能は欲しい。
end note
note as k_dr5 #Turquoise
 １回の受注で、１箇所の届け先に対する１種類の商品１個を、「届け日」と「お届けメッセージ」、「お届け先電話番号」とともに受け付ける。
  出荷日は届け先に関係なく届け日の前日とする。
end note
note as k_dr6 #Turquoise
 いったん受注を受けてから、届け日の変更が要望されることがある。
 その際には可能な限り変更に対応できるようにしたいが、指定日に出荷変更できないようならばその旨を顧客に直ちに伝えられるようでなければならない。
end note
note as k_dr7 #Turquoise
 単品を結束して商品（花束）にするための工程は十分に効率化されていて、材料さえあれば一瞬で結束可能とみなしてよい。
 したがって、出荷日当日に結束指示すれば出荷可能である。
end note
note as k_dr8 #Turquoise
 単品を発注する際、単品毎に発注リードタイム（入荷されるまでにかかる日数）が異なる。
 発注リードタイムさえ越えていれば、どんな将来の入荷向けの単品も発注可能だし、入荷日の変更要望も受け付けてもらえる。
end note
note as k_dr9 #Turquoise
 「単品」毎に購入単位数が決まっている。たとえば、５０本必要だとしても、購入単位が１００本ならば１００本買わなければならない。
 なお、仕入先の供給能力は十分かつ、納期も正確とみなしてよい。
end note
note as k_dr10 #Turquoise
 発注の判断は、在庫推移（日別の在庫予定数）をみながら人間が行う。
 したがって、自動発注処理を考える必要はない。
end note

ac_02 -- k_r3
ac_02 -- k_r4
ac_02 -- k_r5
k_r3 -- k_dr2
k_r3 -- k_dr3
k_r4 -- k_dr4
k_r4 -- k_dr5
k_r4 -- k_dr6
k_r4 -- k_dr7
k_r5 -- k_dr8
k_r5 -- k_dr9
k_r5 -- k_dr10

@enduml
----

=== システム外部環境

==== ビジネスコンテキスト

[plantuml]
----
@startuml

title ビジネスコンテキスト図

left to right direction

actor 顧客 as ac_01

node WEB店舗 {
  usecase 受注管理 as uc_01
}

node 店舗 {
  actor スタッフ as ac_02

  usecase 発注管理 as uc_02
  usecase 在庫管理 as uc_03
  usecase ユーザー管理 as uc_04
  artifact 商品 as ar_01
}

ac_01 -- (uc_01)
ac_02 - (uc_01)
(uc_01) -- (ar_01)
ac_02 -- (uc_02)
(uc_02) -- (ar_01)
ac_02 -- (uc_03)
(uc_03) -- (ar_01)
ac_01 -- (uc_04)
ac_02 -- (uc_04)

@enduml
----

==== ビジネスユースケース

===== ユーザー管理

[plantuml]
----
@startuml

title ビジネスユースケース図 - 受注管理

left to right direction

actor 顧客 as ac_01
actor スタッフ as ac_02

usecase ユーザー登録 as uc_01
usecase ユーザー認証 as uc_02

ac_01 -- (uc_01)
ac_01 -- (uc_02)

ac_02 -- (uc_01)
ac_02 -- (uc_02)

@enduml
----

===== 受注管理

[plantuml]
----
@startuml

title ビジネスユースケース図 - 受注管理

left to right direction

actor 顧客 as ac_01
actor スタッフ as ac_02

usecase 商品の閲覧 as uc_01
usecase 商品の注文 as uc_02

ac_01 -- (uc_01)
ac_01 -- (uc_02)

ac_02 -- (uc_02)

@enduml
----

===== 発注管理

[plantuml]
----
@startuml

title ビジネスユースケース図 - 発注管理

left to right direction

actor スタッフ as ac_01

usecase 商品の発注 as uc_01
usecase 商品の検収 as uc_02

ac_01 -- (uc_01)
ac_01 -- (uc_02)

@enduml
----

===== 在庫管理

[plantuml]
----
@startuml

title ビジネスユースケース図 - 在庫管理

left to right direction

actor スタッフ as ac_01

usecase 商品の入荷 as uc_01
usecase 商品の出荷 as uc_02

ac_01 -- (uc_01)
ac_01 -- (uc_02)

@enduml
----

==== 業務フロー

==== 利用シーン

==== バリエーション・条件

=== システム境界

==== ユースケース複合図

=== システム

==== 情報モデル

==== 状態モデル

== 開発

=== 仕様

==== コンテキストマップ

[plantuml]
----
skinparam componentStyle uml2

component [AuthContext] <<認証・認可>>

----

==== ユースケース

image:images/jig/service-method-call-hierarchy.svg[]

===== 認証・認可

[plantuml]
----
@startuml
left to right direction
actor "ユーザー" as user
rectangle 認証・認可 {
  usecase "ユーザーの認証" as UC1
}
user --> UC1
@enduml
----
=== 設計

==== アプリケーションアーキテクチャ

image::images/jig/architecture.svg[]

==== ドメインモデル

image::images/jig/business-rule-relation.svg[]

===== 認証認可

[plantuml]
----
skinparam componentStyle uml2

package mrs.domain.model.auth {
	package "'User' Aggregate" <<Rectangle>> {
		class User <<(E,DarkSeaGreen) Entity>> {
		}
		class UserId <<(V,DarkSeaGreen) Value Object>> {
		}
		class Name <<(V,DarkSeaGreen) Value Object>> {
		}
		class Password <<(V,DarkSeaGreen) Value Object>> {
		}
		enum RoleName {
            ADMIN,
            USER
		}

        UserId --* User
        Password --* User
        Name -* User
        User *- RoleName
	}
}
----
==== データモデル

image::images/schemaspy/tables/usr.1degree.png[]

== 運用

=== 開発

=== テスト

=== ビルド

=== デプロイ

== 構築

[cols="1,1,1"]
|===
|ソフトウェア |バージョン |備考
|Java
|17
|
|Node.js
|16.3.0
|
|===

=== アプリケーションコンポーネント

==== プロダクション・開発環境

[plantuml]
----
package "UI" {
  [React]
}

package "API" {
  [SpringBoot]
}

database "DB" {
  frame "H2" {
    [test]
  }

  frame "PostgreSQL" {
    [development]
    [production]
  }
}

[React] -> [SpringBoot]
[SpringBoot] -- [test]
[SpringBoot] -- [development]
[SpringBoot] -- [production]
----

=== コンポーネントセットアップ

==== 開発関連

===== 開発ツール

[source,bash]
----
npm init -y
npm install --save-dev @babel/core @babel/cli @babel/preset-env @babel/register
npm install --save-dev npm-run-all watch foreman cpx rimraf marked@1.2.2
npm install --save-dev webpack webpack-cli html-webpack-plugin webpack-dev-server
touch Procfile.dev
----

==== ドキュメント関連

===== Asciidoctor

[source,bash]
----
npm install --save-dev asciidoctor asciidoctor-kroki
----

==== フロントエンド関連

===== Cypress

[source,bash]
----
npm install cypress
npmx cypress open
npm install --save-dev cypress-cucumber-preprocessor
npm install --save-dev cucumber-html-reporter
----

===== React

[source,bash]
----
npm install --save-dev jest
npm install react react-dom
npm install --save-dev babel-loader @babel/preset-react
npm install --save-dev @testing-library/react @testing-library/jest-dom
npm install --save-dev sass-loader sass style-loader css-loader
npm install --save-dev identity-obj-proxy
npm install react-router-dom
npm install --save-dev typescript ts-loader
npm install --save @types/react @types/react-dom @types/react-router-dom
npm install --save-dev @types/jest@27.4.1 ts-jest@27.1.4
npx tsc --init
npm install -save @reduxjs/toolkit react-redux
npm install -save axios @types/axios
npm install --save-dev react-hook-form
npm install cross-env
----

== 配置

=== システムアーキテクチャ

[plantuml]
----
@startuml
actor 開発者
actor 利用者

cloud "Vercel" as vercel {
    package "Production Environment" as ui_prd_env {
      [UI] as ui_prd
    }
}

cloud "Heroku" as heroku {
    package "Production Environment" as api_prd_env {
      [API] as api_prd
      [DB] as db_prd
    }
}

cloud "GitHub" as github {
  [Git] as repository
}

開発者 --> repository
repository --> heroku
repository --> vercel
api_prd -> db_prd
api_prd <-- ui_prd
ui_prd <-- 利用者
@enduml
----

=== CIセットアップ

[source,bash]
----
git update-index --chmod=+x gradlew
----

=== Herokuセットアップ

[source,bash]
----
heroku create ape2022-take15
----

== 参照

- https://www.benkyoenkai.org/contents/Bouquet1-2[花束問題V1.2]
